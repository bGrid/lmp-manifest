resources:
  containers:
  - container: bitbakeContainer
    image: lmp-bitbake
    endpoint: 'bGridContainerRegistry'

variables:
  - group: Prod Variables

jobs:
- job: build_dockerfile
  # Build dockerfile only on master
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: Docker@2
    inputs:
      containerRegistry: 'bGridContainerRegistry'
      repository: 'lmp-bitbake'
      command: 'buildAndPush'
      # tags: $(Build.SourceVersion)
      tags: latest
      Dockerfile: '**/Dockerfile'
- job: init_workspace
  # pool: Compute Intensive
  container: bitbakeContainer
  steps:
    - task: Cache@2
      inputs:
        key: lmp | $(Build.SourceBranchName) | $(Build.SourceVersion)
        path: workspace
        restoreKeys: |
            lmp | $(Build.SourceBranchName) | $(Build.SourceVersion)
            lmp | $(Build.SourceBranchName)
      displayName: Restore bitbake build cache
    - task: InstallSSHKey@0
      inputs:
        knownHostsEntry: 'ssh.dev.azure.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7Hr1oTWqNqOlzGJOfGJ4NakVyIzf1rXYd4d7wo6jBlkLvCA4odBlL0mDUyZ0/QUfTTqeu+tm22gOsv+VrVTMk6vwRU75gY/y9ut5Mb3bR5BV58dKXyq9A9UeB5Cakehn5Zgm6x1mKoVyf+FFn26iYqXJRgzIZZcZ5V6hrE0Qg39kZm4az48o0AUbf6Sp4SLdvnuMa2sVNwHBboS7EJkm57XQPVU3/QpyNLHbWDdzwtrlS+ez30S3AdYhLKEOxAG8weOnyrtLJAUen9mTkol8oII1edf7mWWbWVf0nBmly21+nZcmCTISQBtdcyPaEno7fFQMDD26/s0lfKob4Kw8H'
        sshKeySecureFile: id_rsa_azure
    - script: |
        mkdir -p bin
        wget http://commondatastorage.googleapis.com/git-repo-downloads/repo > bin/repo
        chmod a+x bin/repo
        ./bin/repo init -u git@ssh.dev.azure.com:v3/bGridSolutions/Gateway/lmp-manifest
        ./bin/repo sync
      workingDirectory: workspace
      displayName: get_sources
    - script: |
        ls . -hal
        ls workspace -hal